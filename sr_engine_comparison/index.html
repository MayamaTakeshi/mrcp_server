<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

      #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
      #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
      #input:focus { outline: none; }
      #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages > li { padding: 0.5rem 1rem; }
      #messages > li:nth-child(odd) { background: #efefef; }
    </style>

    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />

    <script src="//polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>

    <!-- Load Vue followed by BootstrapVue -->
    <script src="//unpkg.com/vue@latest/dist/vue.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

    <!-- Load the following for BootstrapVueIcons support -->
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

    <style>
    .centercontent {
        padding:10px;
    }

    /* for validator */
    a:link {
    text-decoration:none;
    }
    </style>
  </head>
  <body>
    <div id="vue1">
        <div class="col-md-12">
            <div class="centercontent">
                <b-button variant="success" v-on:click="handleClick">{{ working ? 'Stop' : 'Start' }}</b-button>
            </div> 
         </div>

         <b-table id="vue1" striped hover fixed :items="items" :fields="fields"></b-table>
    </div>

    <audio id="the_audio"/>

    <script>
      var socket = io()

      var items = []

      var vm = new Vue({
        el: '#vue1',
        data: {
          fields: ['google', 'olaris', 'julius'],
          items: items,
          working: false,
        },
        methods: {
            handleClick: function() {
                if(this.working) {
                   socket.emit('stop')
                } else {
                   socket.emit('start')
                }
            }
        }
      })

      function float32ToLinear16(float32Arr) {
        var int16 = new Int16Array(float32Arr.length)
        for (var i =0; i < float32Arr.length; ++i) {
          // force number in [-1, 1]
          var s = Math.max(-1, Math.min(1, float32Arr[i]))

          // convert 32 bit float -> 16 bit int.
          // 0x7fff = max 16 bit num. 0x8000 = min 16 bit num.
          int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF
        }
        return int16
      }

      var constraints = { audio: true, video: false}

      navigator.mediaDevices.getUserMedia(constraints)
      .then(function(mediaStream) {
          var audio = document.querySelector('#the_audio')
          audio.srcObject = mediaStream

          const context = new AudioContext({sampleRate: 8000})
          const source = context.createMediaStreamSource(mediaStream)
          const processor = context.createScriptProcessor(1024, 1, 1)

          source.connect(processor)
          processor.connect(context.destination)

          processor.onaudioprocess = function(e) {
              //if(vm.working) {
                  var float32Audio = event.inputBuffer.getChannelData(0) 
                  var linear16 = float32ToLinear16(float32Audio)
                  var data = linear16.buffer
                  socket.emit('audio', {data: data})
                  //console.log(data)
              //} 
          }
      })
      .catch(function(err) { console.log(err.name + ": " + err.message) }) // always check for errors at the end.

      socket.on('started', () => {
        console.log("received started")
        vm.items.unshift({}) 
        vm.working = true
      })

      socket.on('partial', data => {
         console.log("received partial")
         Vue.set(vm.items, 0, data)
      })

      socket.on('final', data => {
         console.log("received final")
         Vue.set(vm.items, 0, data)
         vm.working = false
      })
    </script>
  </body>
</html>
